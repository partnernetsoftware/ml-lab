

https://www.fmz.com/bbs-topic/1063

```
高频交易的 Order Book

    为什么要关注 order book？

    Limit order book 是所有买家和卖家会合的地方，也是所有竞价发生的地方。本质上讲，它就是所有的供给和需求。当我们看到 order book 的时候，我们就看到了所有市场参与者的决策和策略。如果说交易数据展示的是已经发生的情况，那么 order book 展示的则是交易者的意向。根据这一信息，可以预测短期的价格走势。

    通过跟踪和分析 order book 能得到许多信息，例如：

    找到有流动性的价格水平。某些价格水平能吸引大量的报价单，而这种报价单的集聚只有通过深度观察市场才能识别出来。当上述价格水平低于现价时，常常体现为支撑点；高于现价时，则会体现为阻力点。

    通过观察买卖价差，推测在最近的未来会发生什么。

    识别市场日内动量方向的转换，例如从强劲买盘到强劲卖盘的转换。

    研究 order book 的变动与市场价格变化的关系。

    我们利用市场深度数据还能观察策略的运行情况，例如：

    价格触发策略，也就是基于价格变化自动改变交易方向的策略。

    验证某些关键的技术面指标是否发生了突破，并且更好地识别出它是假突破还是真突破。

    识别出是否有大玩家进场。

    识别出零售行为。

    使用 order book 的方法有很多。投机者（scalper）会使用 order book 中的信息来决定是做多还是做空；波段交易者（swing trader）或者崇尚技术分析的交易者可能会以此来论证他们宏观上的买入或卖出的决策。

    处理 limit order book 时遭遇的挑战

    量化分析师或交易员在跟 order book 打交道的时候，大多要面临下面这些挑战。

    高频交易策略为了抢占先机，会在许多价格水平上挂限价单。通常这些挂单行为是由价格变化触发的。然后，随着市场价格接近委托单价格，大多数单子会被撤销。

    并非所有的限价单都代表着真实的交易意向。有些交易者会通过挂单来操纵市场、创造流动性很强或很弱的假象。他们的手段包括“声东击西”（spoofing）和“阻塞交通”（quote stuffing）。

    有时候，并非所有的交易委托单都会显示在 order book 上。许多交易所都有某些类型的隐藏的委托单。

    了解微观结构

    每个宏观事件都是微观事件的集合。许多时候，如果你能够理解微观结构，那么你就能更好地理解宏观现象。研究微观结构的好处是重大事件比较少，因此更容易解读市场参与者的行为及其意向。学习微观结构最好的方法是使用可视化工具，放大观察市场数据的基础组成部分。

    如何将 order book 可视化

    当年我们还在做高频交易策略的时候，就不得不面对这个问题了。我们当时想要更好地理解其他类型的市场参与者，还想知道当我们下单的时候市场会有何反应。我们决定把 order book 转化成热力图的形式，以每秒 25-40 帧的频率更新。这个热力图会记录并绘制 order book 的每个变化，把变化展示成不同灰度的阴影。阴影颜色越浅，意味着在对应的价格水平上等待交易的委托单越多，也就是说流动性越强；相反，阴影颜色越深，流动性就越弱。

    这个热力图让我们清晰地看到整个 limit order book 和交易量如何随时间变化，从而让我们能够更快、更深刻地洞察市场机制。下面容我详细解释一下。常规的图表，例如柱状图，都是二维的（价格和时间）。当你使用热力图的时候，你就给图表增加了一个维度，因此你可以看到历史上每个时刻的每个价格下的委托单规模。此外，通过以40次/秒的高频率更新数据，你可以获得一个视频，让你查看变化的频率，“感受”到市场的加速度。

    可视化能够让你看到你此前无法看到或理解的模式：
    每个价格水平上的委托单规模如何随时间而变化？
    当价格接近某一价格线（支撑线或阻力线）时，这条线会如何移动？
    在这条价格线的下方或上方，是否有更强的支撑线或阻力线？
    在这条价格线附近的成交量是多少？
    在 order book 的另一侧发生了什么？是否存在一些区域，在这些区域里 order book 是不对称的？

    价格反弹现象

    在几个相邻的询价（ask）水平上聚集着大量的限价卖单。通常我们希望实时检验如下假设：如果价格达到这样的水平，那么之后价格会反弹（至少一小段时间）。以下是可以支持该假设的一些现象：
    当价格接近这个水平时，卖家的数量：

        a. 保持不变，或者

        b. 变得更大（在这种情况下，有可能该水平上的交易还没有发生，价格就反弹了）

    当这个价格水平上开始有委托单成交的时候：

        a. 更多的卖家加入，而且/或者

        b. 我们观察到隐藏的卖单正在被执行，它们的对手盘是市价买单。

    order book 中的重大变化

    在一瞬间，几张大额买单被取消，同时增加了几张大额卖单。随后是价格下跌。根据我们刚才我们放大观察到的情况，这些委托单很可能属于同一个交易者。

    1、更大的透明度

    组织和个人都需要更广泛和更准确的数据。你拥有的数据越多（例如来自不止一个交易所）以及细节越详尽，你就越能作出明智的决策。在我们观察市场的时候，我们已经发现了这些趋势。一个很好的例子是，即将推出的CME Market by Order数据，它提供了各个委托单排队位置及其数额。有了这一信息，交易员不再需要自己计算排队位置，从而可以作出更加明智的决策。

    2、更多的数据分析和可视化

    随着技术的进步，更多的数据被收集起来，被实时或按需传输（得益于更快的互联网），被普通的计算机分析和可视化（得益于更好的GPU）。与其他行业一样，金融行业将需要更好的数据分析和可视化应用程序。这些程序不仅可用于离线研究，还可实时使用，目的是作出更快更好的决策。

    3、可视化工具的交互性、灵活性和模块化

    可视化软件应该对数据源更加中立，并且能够聪明地展示各种来源的数据。另外，随着数据的增多，与之接触的方式也会更加灵活。例如，想象一下你可以使用自己的数据，自己选择参数并构建视频（就像在Excel中构建图表一样），使用自己的指标丰富这个视频，并决定是否要离线观看或实时观看。这些分析方式不仅可以服务于算法开发人员或者量化分析师，还可以服务于交易员和其他市场分析人员。

    4、数据分析自动化

    更多的数据也意味着更高的数据维度（不同的现象类型，数据异常，不同的工具，不同的时间尺度等）。如今的数据分析工作大多是在二维中完成的，但将来也可以在三维或四维上完成，从而增加用户的洞察力和竞争优势。然而，人的感知维度是有限的（例如3D视觉、音频等），因此有必要执行初步的自动数据分析，生成警报并将初步的结果中有意义的部分展示出来。

```

https://blog.csdn.net/wqfhenanxc/article/details/79869089

```
交易委托账本

处于证券交易的核心位置，所有的交易都围绕它进行。这个词很多人可能没听说过，但我们日常看到的不同形式的一级和二级股票行情就是委托账本的不同表现形式，这样说的话大家可能就能猜到它的重要性。很多高频交易都要深入研究交易委托账本，观察市场的微观特性，这是在制定交易策略时的最重要的一步。在实际交易中还要研究交易委托账本来观察交易策略的执行情况。

委托账本就是券商送到交易所的限价委托单，如果当时无法成交，就会自动纪录到交易所的交易委托账本里，等待成交机会。

下面就是多伦多证券交易所的一家能源公司(CKE)当前的账本的样子：

最新成交价: 1.76

最新成交量: 1700

总成交量: 42749

开盘价: 1.79

最高价: 1.80

最低价: 1.76

收盘价: 0.00

交易暂停: 否

交易委托账本(Order<wbr>Book)

上面这个帐本包括两部分内容，上面的部分记录了这支股票的一些基本信息，比如开盘，成交量等，下面部分的表格里是每一个委托的限价和数量。除了限价和数量，账本上还记录了每一笔委托相关的所有信息，包括交易员号码(Trader ID)，券商号码(Firm ID)，客户委托号(Client Order ID)，客户账号(AccountID)，委托时间，委托号(Order ID) 等信息，在这里就不列出了。

上面的账本只显示了最上面一部分的委托，全部的委托会很长。对于交易活跃的股票，一个帐本里会有几万个委托或更多。对于交易不活跃的股票，可能里面是空的，这种情况下结果就是无法买卖这支股票。因此账本里的委托也叫流动性(Liquidity)，交易所十分关心这种流动性的多少，对于能向账本里提供流动性的交易者，有的交易所会给与补助。

委托账本上买入和卖出是分开记录的，也就是说账本分成买入和卖出两部分，就像上面表格里显示的那样。上面的账本上黄色标识出的部分是当前最好价格(Topof the book，或叫BBO, Best BidOffer)，对于买入来说就是最高价，卖出就是最低价。

交易的过程

当有新的委托进来的时候，就会查找当前这支股票的账本，看最好价格能不能成交。下面是一些委托在交易所交易的过程。

限价1.76买入1000股CKE：

查询CKE的卖出账本，最优价格是1.79，高于委托的1.76限价，无法成交。下面就是当前卖出最优价格：

交易委托账本(Order<wbr>Book)

将这个1.76限价委托加入到买入委托账本中(注：不是所有的限价委托都会进入委托账本，比如有些委托种类像IOC，就会被撤掉，不同的交易所对此有不同的规则)

通过行情数据发布这个委托。交易股票的人们就会在自己的电脑屏幕上看到在1.76价位上多了1000股的委托

限价1.80买入1000股CKE

查询这支股票的卖出帐本，在1.80或更好的价位上共有3笔卖出委托，两笔在价格1.79，共计5700股，一笔在1.80，共计100股

交易委托账本(OrderBook)

交易顺序是价格优先，时间优先。最优价位1.79上有两笔委托共有5700股，其中5600股委托在11:41提交，另一个100股委托在12:03提交。因此交易所选择最先提交的5600股的卖出委托和这个买入委托进行交易

上面的交易完成后交易所会马上给买方和买方的券商各发一个交易报告。买方会受到一个委托全部成交的报告，卖方会收到一个1000股委托部分成交的报告，卖方还剩下4600股

交易所同时还会更新这支股票的账本，将5600股的委托改成4600股

交易所通过行情数据发布这笔交易和更新过的账本

市价买入6000股CKE：

查询这支股票的卖出帐本，最优价位1.79上有两笔委托共有5600股，不够完成这个交易。下一个价位1.80上有100股，还是不够。在下一个价位1.82上有2500股，从中取出200股完成这笔交易

交易委托账本(Order<wbr>Book)

因此这个市价买入委托会产生四笔交易：

1.79 x 5600股

1.79x100股

1.8x100股

1.82x200股

上面的交易完成后买方会收到三个委托部分成交的报告，一个全部成交的报告（最后一个），前三个卖方会各收到一个全部成交的报告，最后一个卖价会受到一个200股的部分成交报告

交易所同时还会更新这支股票的账本，将前三个委托撤掉，将2500股的委托改成2300股。这时这个1.82x2300股的委托就成了最优价格(Topof the book)

交易所通过行情数据发布这笔交易和更新过的账本

证券市场的流动性：

上面我们在谈到新提交的委托如何和账本里的委托交易的过程。对于白天的连续交易，交易总是发生在新进来的委托和账本里的委托之间。有一种情况，如果账本里是空的会怎样？比如上面的例子，我们要1.79买入1000股CKE，交易所在收到这笔委托后，察看卖出委托账本，发现里面时空的，交易所找不到交易的另一方，所以交易无法进行。这种情况下，交易所会把这个委托方到买方的委托账本里，等待交易机会。在没成交前，客户都可以通过券商取消委托。

从另一面来说，如果账本里委托很多很多又会如何？比如在账本的最优价位上买方总有一百万股，卖方总有一百万股。这样的情况下，任何进来的市价或好于最优价位限价的委托都会立即在最优价位上成交。比如说我们限价1.80买入1000股CEK，在卖方委托账本里1.79价位上有100万股，那么马上就会以1.79成交。

交易所的实际情况介于上面两种极端情况之间，一般账本既不会空，也不会在买卖两边最优价位上有一百万股。有的股票在账本里的委托很多，并且在被交易后不断有新的委托补充进来，始终保持足够的委托。这种股票就很容易买卖。有些股票在账本里的委托很少，并且账本里的委托被交易后没有新的委托进来，这样的股票就很难买卖。

在金融领域里，流动性是指资产以合理的价格变现的能力，如果这个资产很容易以我们想要的价格变现，就说它流动性好。对股票交易来说，如果一只股票的账本里的最优价位或相近价位的委托多，股票就容易交易，我们就说这种股票的流动性好。那么账本里的委托就习惯上就叫流动性，而向账本里提交委托就是增加流动性。

增加流动性直接受益人显然是交易所，因为交易变得容易了之后，会增加交易量，交易所会得到更多的交易收入。在北美和欧洲，交易所众多，竞争激烈，交易所对于增加流动性的委托不但不会收费，还会有补助。

在北美的证券交易所，从一百多年前开始就实行专家经纪人(Specialist)制度，专家经纪人用自己的账户向市场提供流动性。在电子交易兴起后，出现了很多做市商(Market Maker)，他们使用自动交易系统向市场提供流动性，赚取交易所的补助和交易中的差价(Spread)利润。

委托账本的信息披露：

对于一个交易所来说，及时披露交易信息才能做到交易公正透明。我们一般看到的交易所的行情数据其实就是委托账本里的信息。因为账本里的信息量太大，而且很多离最优价格差得太远的委托对交易没什么用处，因此一般的交易平台都不会显示全部的账本里的内容，最常见的是以一级情数据和二级行情数据。

一级行情数据：

一级行情数据就是买卖最优数量和价格，其中的数量就是在最优价位上的全部委托的总数量，比如下面的最优价格1.79上有两个委托，共计5700股。交易者在卖盘上看到的就是1.79x5700：

交易委托账本(Order<wbr>Book)

因此一级行情数据就是在最优价格上的价位和数量。因此最优价位上委托的任何变化就会产生一个新的一级行情报价：

最优价位上收到新的委托

最优价位撤掉了已经存在的委托

最优价位上委托改变了数量

最优价位上委托改变了价格

收到新的委托，价格好于最优价格，于是新的最优价格产生

不难想象，一级行情变化很快。交易活跃的股票每秒钟会有上万个委托，因此每秒钟可能会有上万个新的行情数据，人的眼睛是无法看清这么快的变化的。我们用的交易软件一般都会每隔一段时间显示一个新的行情，间隔比如一秒钟或几秒钟。但我们要明白，交易所其实是发布了所有的数据，只是我们的交易软件作了处理，行情数据上去才变化这么慢。

对于自动交易系统来说，有些交易策略就要看清每一个最优价格上的变化，比如说有些做市商软件。

二级行情数据

二级行情数据一般就是发布委托账本里的每一笔委托的具体内容。行情数据只发布委托的基本公开数据，比如价格，数量，委托时间，交易所分配的委托号等。委托的涉及个人信息的部分不会发布，比如说客户帐号，交易员等不会被发布到行情数据中去。

用户在收到二级行情数据后，可以自己在系统里重建委托账本，还可以使用自己建的账本来支持某些特殊交易算法。

上海交易所和深圳交易所有些不同，他们不发布委托账本的详细内容，他们采用每隔几秒钟发布一个经过处理的快照(Snapshot)。上海交易所的二级行情也不是通常说的委托账本详细内容，而是按价位合并的十级行情，并且是隔几秒才发布一个快照。这种行情数据完全隐藏了具体的交易情况，没人知道交易时的情况。与其说是交易所，其实更像现在十分流行的暗池(Dark

Pool)。暗池因为人们看不清里面的内容，因此很受机构投资者的欢迎。

委托账本的种类：

交易所对每一支股票都设有一到几个委托账本。较常见的有：

连续交易账本(Continuoustrading book)：

这是最重要的账本，日常的普通交易都是使用这个账本。我们白天看到的行情数据的发布也是发布这个账本里的内容。

开盘委托账本(Pre-openbook)

这个账本记录的是在开盘前收到的参加开盘集合竞价交易的委托。不同的交易所接受开盘委托的时间不同，有的是从早上7:00开始，到9:30开盘前截止。在这个过程中，交易所不断的计算并发布根据当前委托账本计算出来的开盘价，直到开盘时，交易所停止接受开盘委托，然后完成并发布所有的开盘交易，撤销没成交的委托，或将没成交的委托转到连续交易账本里，加入到全天的连续交易当中。

收盘委托账本(Market onclose book)：

这个账本记录的是参加收盘集合竞价交易的委托。收盘委托很多交易所全天都可以提交，可以分为市价委托和限价委托

非整数股票账本(Odd Lotbook)：

非整数委托的意思是比如一手股票是100股，如果我要卖60股，那么这个委托就会被送到这个非整数股票账本上来。一般这个账本里的股票交易所要派专人来用自己的账户和他们交易，因此交易价格可能和当前市价略有差别。有些数交易所不支持这类交易。

一般股票在合并时会产生非整数股，比如最近的花旗银行，股价长期在四美元左右徘徊，这对公司股价很不利，因为有很多基金会避免选择五美元以下的股票，而且对公司形象不利。这种情况下，花旗银行进行的十股合一股的股票合并，股价也就调整为原来的十倍，变为四十元左右。如果某个投资者原来有800股花旗银行股票，那么他现在手里的股票就变为80股，成了非整数股。

如果一个人要卖580股，一般交易所不接受这样的数量委托，他必须提交一个500股整数委托和一个80股非整数委托，500股整数委托按通常的交易方式自动交易，80股非整数委托由交易所的专人来交易。

特殊交易条件账本

特殊交易条件指的主要是特殊清算条件，比如说特殊清算日期等。比如我提交一个委托，市价卖出500股TEK软股票，但条件是我要在一个月后才清算。这样一个委托只能和另一个有同样清算日期条件的委托才能交易，

委托交易顺序：

在交易所收到一个新的委托时，如果这个委托可以和当前委托账本中的委托交易，交易所就要根据事先制订的优先顺序规则，从账本中选一个或几个委托来和新进来的委托交易。一般的选择顺序是：

价格优先，最优价格的委托先交易。最优价格对于卖出委托就是最低价，对于买入委托就是最高价

委托提交时间优先。在价格相同的情况下，先提交的委托先交易

价格优先+时间优先是最常见的规则，但有些交易所还有另外的条件。比如多伦多证券交易所实行价格优先，然后是同一券商优先，最后是时间优先的规则。同一券商优先的意思是，如果账本中的某一个委托和新进来的委托是来自同一个券商，那么即使这个委托比相同价位的其他委托进来的晚，也会先和这个委托成交。

同一券商优先的结果是：如果账本里的一个委托来自一个很小的券商，那么这个委托在账本里等了很久，比它后进来的很多委托都成交了，它还在委托账本里。因为委托大多数都来自于大的券商(为什么？没有那么多委托还怎么叫大券商？)，这些委托都会首先和账本里的那个券商的委托成交。

也就是说，越大的券商提交的委托越容易成交。你可能很容易就会想到，人们选择券商时，首先选择最大的券商，那小券商岂不是很难生存？听上去这是一个很不公平的规则，但事实上很多人并不知道这一规则的存在，包括很多业内人士。因此人们在选择券商时，一般不会注意到这一点。但对于有些交易者，比如做市商(Market

Maker)，这就是致命的，他们一定会选择大的券商。另外，价格优先是第一位的，只要你出的价格比其他人好，那你就一定会成交。

这一规则的背景是这样的，多伦多证券交易所是由几个大的券商共同成立的，券商联合起来找了个地方来交易股票，也就是说是券商控制着交易所。这就不难理解，大券商在制订交易所规则的时候充分考虑了自己的利益，而同一券商优先规则就是大券商争取自己利益最大化的结果。

由券商来组建交易所是很自然的事情，因为券商的出现早于交易所。只有交易达到一定规模，才需要交易所。这和中国的情况不同，中国似乎是交易所地位远高于券商，经常是规则的制订者，而券商没什么太大的话语权。
```
